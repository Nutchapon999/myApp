@model IEnumerable<myApp.Models.User>
@{
    ViewBag.Title = "Download";

}

<link rel="stylesheet" href="/CSS/Style.css">
<div class="container d-flex mb-5 p-2 card-container">
    <div class="col-auto d-flex align-items-center ">
        <label for="selectCompany" class="form-label me-2 mt-2"> บริษัท:</label>
        <select class="form-select" id="selectCompany" style="width: 100px">
            <option value="">-</option>
            @foreach (var dpt in Model.Where(cdt => cdt.Company != null).Select(cdt => cdt.Company).Distinct())
            {
                <option value="@dpt">@dpt</option>
            }
        </select>
    </div>
    <div class="col-auto d-flex align-items-center ms-2">
        <label for="selectYear" class="form-label me-2 mt-2">ปี:</label>
        <select class="form-select" id="selectYear" style="width: 100px">
            <option value="">-</option>
            @foreach (var dpt in Model.Where(cdt => cdt.Result.Year != null).Select(cdt => cdt.Result.Year).Distinct())
            {
                <option value="@dpt">@dpt</option>
            }
        </select>
    </div>
    <div class="col-auto d-flex align-items-center ms-2">
        <label for="DataListCostcenter" class="form-label me-2 mt-2">Cost Center:</label>
        <input class="form-control" list="selectCostCenter" id="DataListCostcenter" placeholder="ค้นหา" style="width: 100px">
        <datalist id="selectCostCenter">
            @foreach (var costCenter in Model.Where(cdt => cdt.CostCenter != null).Select(cdt => cdt.CostCenter).Distinct())
            {
                <option value="@costCenter"></option>
            }
        </datalist>
    </div>
    <div class="col-auto d-flex align-items-center ms-2">
        <label for="DataListUserID" class="form-label me-2 mt-2">รหัส:</label>
        <input class="form-control" list="selectUserId" id="DataListUserID" placeholder="ค้นหา" style="width: 100px">
        <datalist id="selectUserId">
            @foreach (var Id in Model.Where(cdt => cdt.Id != null).Select(cdt => cdt.Id).Distinct())
            {
                <option value="@Id"></option>
            }
        </datalist>
    </div>
</div>
<table class="table table-hover table-responsive table-striped" id="myTB">
    <thead style="background-color: #2D4686; color: #C8E8FF">
        <tr class='text-center'>
            <th>ข้อ</th>
            <th>รหัส</th>
            <th>ชื่อ</th>
            <th>ตำแหน่ง</th>
            <th>ตำแหน่งขั้น</th>
            <th>idp</th>
            <th>Critical</th>
            <th>Competency Id</th>
            <th>R</th>
            <th>A1</th>
            <th>Gap1</th>
            <th>Priority</th>
            <th>Type</th>
            <th>Development Plan</th>
            <th>Q1</th>
            <th>Q2</th>
            <th>Q3</th>
            <th>Q4</th>
            <th>Development Result</th>
            <th>A2</th>
            <th>Gap2</th>
        </tr>
    </thead>
    <tbody id="tableContainer">
            
    </tbody>
</table>
<script src="~/Scripts/jquery-3.7.0.min.js"></script>
<script>
    $(document).ready(function () {

        $("#selectYear, #selectIDPGroup, #selectCompany, #DataListCostcenter, #DataListUserID").change(function () {
            filterTable();
        });
        var send = '@Url.Action("GetListDownload", "Home")';

        function filterTable() {
            var selectedCompany = $("#selectCompany").val();
            var selectYear = $("#selectYear").val();
            var selectCostCenter = $("#DataListCostcenter").val();
            var selectUserId = $("#DataListUserID").val();

            console.log(selectedCompany);
            console.log(selectYear);
            console.log(selectCostCenter);
            console.log(selectUserId);

            $.ajax({
                url: send,
                type: "POST",
                data: {
                    selectedCompany: selectedCompany,
                    selectYear: selectYear,
                    selectCostCenter: selectCostCenter,
                    selectUserId: selectUserId,
                },
                success: function (response) {
                    console.log(response);
                    buildTable(response);
                },
                error: function () {

                }
            });
        }
    });

    function buildTable(users) {
        var tableHtml = "";
        var src = '/Images/hexagon_icon.png';

        for (var i = 0; i < users.length; i++) {
            var user = users[i];

            var rowHtml = "<tr>" +
                            "<td class='text-center'>" + user.ResultItem.ResultItemId + "</td>" +
                            "<td class='text-center'>" + user.Id + "</td>" +
                            "<td>" + user.FirstNameTH + user.LastNameTH + "</td>" +
                            "<td>" + user.Position + "</td>" +
                            "<td class='text-center'>" + user.JobLevel + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.IDPGroupId + "</td>" +
                            "<td class='text-center'>";
                                if (user.ResultItem.Critical == true)
                                    rowHtml += "<img src='" + src + "' width='25' height='25' />";
                            rowHtml += "</td>" +
                            "<td class='text-center'>" + user.ResultItem.CompetencyId + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Requirement + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Actual1 + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Gap1 + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Priority + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.TypePlan + "</td>" +
                            "<td>" + user.ResultItem.DevPlan + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Q1 + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Q2 + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Q3 + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Q4 + "</td>" +
                            "<td>" + user.ResultItem.DevRst + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Actual2 + "</td>" +
                            "<td class='text-center'>" + user.ResultItem.Gap2 + "</td>" +
                        "</tr>";

            tableHtml += rowHtml;
        }

        $("#tableContainer").html(tableHtml);
    }

    function exportTableToExcel(tableId) {
        var table = document.getElementById(tableId);
        var workbook = new ExcelJS.Workbook();
        var worksheet = workbook.addWorksheet('Sheet 1');

        for (var i = 0; i < table.rows.length; i++) {
            var row = table.rows[i];
            var rowData = [];

            if ($(row).is(':visible')) {
                for (var j = 0; j < row.cells.length; j++) {
                    var cell = row.cells[j];
                    var cellData = cell.innerText;

                    if (cell.classList.contains("text-center") && cell.querySelector("img") !== null) {
                        cellData = "1";
                    }

                    rowData.push(cellData);
                }
            }

            if (rowData.length > 0) {
                worksheet.addRow(rowData);
            }
        }

        workbook.xlsx.writeBuffer().then(function (buffer) {
            var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'IDP_Export.xlsx';
            link.click();
        });
    }
</script>